// 把 GOT table code_498 位址 填成 code_44 位址
// shuffle  498 對應 index 44
// 修好 GOT table, call成正確的
// elf.got[g] 相對位址 可以用 base 換算 絕對位址
// mprotect(2) 改成可寫記憶體 不能寫： "RELRO:    Full RELRO"
//dlopen(3) and dlsym(3) 可以在 runtime 查出所在位址
#include <stdio.h>
#include <stdlib.h>
#include <dlfcn.h>
#include <unistd.h>
#include <fcntl.h>
#include <string.h>
#include <sys/mman.h>
#include <errno.h>
#include "shuffle.h"

long int got_offset[] = {-1, 100952, -1, 100208, 99712, -1, -1, -1, -1, -1, 98424, -1, -1, 100120, -1, 101544, 98184, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 99696, 97504, -1, 101536, -1, -1, 98832, 98416, 98688, 97632, 99136, 100880, 97744, -1, -1, -1, -1, -1, 102144, 98960, 101368, -1, 98576, -1, 98616, -1, -1, -1, -1, -1, -1, -1, 99088, 99208, 98016, 100344, 99408, 101048, 97888, 101624, 99016, 99120, 98280, 99736, 99952, 101320, 99008, 99928, -1, 102232, 97528, 100136, 96824, 100600, 97728, -1, 98600, 99992, -1, -1, -1, -1, 100712, 100688, 100744, 101896, 99464, 99288, 97880, 97088, 98152, 101512, 101960, 102040, 101648, 99192, 98640, 102120, -1, 102048, 101400, -1, 97416, 97544, 100896, 100112, -1, 101704, 99944, 98160, 102280, 99104, 101448, 98712, 99536, 99920, 97752, -1, -1, 97736, 100200, 98888, 101912, 98000, 98344, 100560, 101480, 98520, 99776, -1, -1, 98584, 98928, 97392, 101688, 99880, 97840, 100784, -1, -1, 96928, 99312, 97568, -1, 97928, 102160, 100960, 99568, 97920, -1, -1, -1, -1, -1, 101272, 97040, 99544, 97104, 99064, 99328, 100904, 102344, -1, 101696, 97696, 100128, 99480, 98432, 101208, 99352, -1, -1, -1, 101128, 99272, 101992, 97312, 101168, 100328, 100392, -1, 97216, 101360, 100488, 101888, 97480, 98112, 100008, 98320, 99616, 100504, 97448, -1, 97320, 98192, 97072, -1, 99072, 101792, 97576, -1, 98728, 100528, 100192, -1, 101776, 101104, 98448, 100456, 96992, 102176, 97960, 98952, 101600, 100552, 100096, -1, 100664, 100624, -1, -1, 102192, 97360, 98968, 100736, 99664, 97240, 99320, 98080, 99032, 97496, 99632, 100536, 99896, -1, -1, -1, -1, -1, 100496, -1, -1, 100448, -1, 101024, 101488, 101336, -1, 98776, 100816, -1, -1, -1, -1, 98248, 101640, 100856, 101616, 97152, -1, 101552, 99576, 99584, -1, -1, -1, 102248, -1, 101352, 98904, -1, -1, -1, 97016, -1, 101824, -1, 100544, 101584, 101848, 97168, -1, 99000, -1, 98264, 99960, 96888, 100680, 101472, -1, -1, -1, 98608, -1, 97984, 97808, 101784, 100640, -1, -1, -1, -1, -1, 102016, 97672, 101136, 96840, 98464, 101152, 101184, 101328, 98384, 100480, 101176, 99672, 101456, 102328, 101296, 98008, 99240, 97096, 101248, 97520, 98224, 98296, 99296, 98880, -1, 98936, -1, -1, 100352, 98144, 100432, -1, 98696, 100864, 99984, 101752, 98488, -1, 97224, 99904, 96936, 100104, 99176, 100568, -1, 96952, 99624, 99744, 99600, 97440, 100976, 97248, -1, -1, 97464, 101464, 98704, 101216, -1, 99440, 98128, -1, 97584, -1, 100616, 98504, 101424, -1, 101224, 97776, 101088, 97080, -1, 100704, 98840, 100384, 100728, 101096, 101312, -1, 97608, -1, 99232, 100992, 100336, 99216, 101864, 98104, 99304, 99848, 97136, 99456, 101064, -1, -1, 97720, 98896, 101040, 101144, 99528, 97656, 100984, 98920, 99200, 98528, 97536, -1, 101800, 99384, 100720, 97712, 101984, -1, 98680, 100376, 98048, 97296, 102336, 96968, 98408, 97280, 98544, 102080, 97768, -1, -1, -1, 96880, 98632, -1, 96816, -1, -1, 97384, 98312, 96976, -1, 99424, 100848, -1, -1, 97352, 102064, 101632, 100408, -1, 97688, 98872, -1, 96920, 101520, 99160, 99704, 98200, -1, 97600, -1, 102024, 101232, 99840, 97680, 100072, 100832, 97560, -1, 100368, 98992, -1, -1, 99824, 99056, -1, 98096, 98328, 100312, 100176, 97272, 97304, 99784, -1, 100024, 99256, 100048, 98496, -1, 99128, -1, 102312, -1, 102104, -1, -1, 100056, -1, 101576, 100160, 97800, 100608, 97472, -1, 99144, 99640, 100288, -1, 99096, -1, -1, 97912, 101528, 100776, -1, 101712, 97616, 101736, -1, 101120, -1, -1, -1, -1, 99336, -1, -1, 98216, 101928, 99048, -1, 97552, 102320, -1, 101720, 99080, 98912, 97488, -1, -1, -1, 97952, -1, -1, -1, 97904, 98592, -1, -1, -1, -1, -1, -1, -1, 97864, 102184, -1, 100808, 100800, 100824, -1, -1, -1, -1, -1, -1, 101056, 99392, 100280, -1, 98536, -1, -1, 100928, -1, 98208, 100040, -1, -1, -1, 99344, 101856, 102272, 99416, 99168, -1, -1, 100888, -1, -1, -1, 100768, -1, 98288, 101192, -1, -1, -1, 101664, -1, -1, -1, -1, -1, -1, -1, 99816, -1, 100080, -1, -1, -1, -1, -1, -1, 101304, 98744, -1, -1, 100968, 100064, -1, 97424, 99832, -1, -1, -1, -1, -1, -1, -1, -1, -1, 98656, -1, -1, 100304, 97944, 99152, 96864, -1, -1, 101568, 97008, 100672, 97968, 99040, -1, 97048, 97648, 96960, 98232, 101496, -1, 97264, -1, 98400, 97288, -1, 102152, 102304, 99520, -1, 99376, -1, 98456, 98360, -1, 101344, -1, 101872, 97184, 100088, 97192, -1, 99976, 97368, 98368, -1, 96984, -1, 99768, 98648, -1, -1, 100000, 99448, 97256, 99024, 102136, 97064, 100232, 101816, -1, 101880, 98824, 101000, 100592, 99968, 97208, 98568, 102128, 100296, -1, -1, 102032, -1, 100752, 98256, 100936, 101808, 98808, 101416, 101920, 100440, -1, 97032, 98736, 98848, -1, -1, -1, 97824, -1, -1, 97120, -1, 97848, -1, 98512, 99656, -1, 97432, 98176, 102000, -1, -1, 101432, 101840, 97896, 102216, 99224, -1, 101032, -1, 99792, 98480, 101384, -1, -1, 99720, -1, 97760, 100168, -1, -1, -1, 99912, -1, 97784, -1, 99432, -1, 97400, 98976, 101016, 98800, 100760, 99760, 97936, 96832, 99184, -1, -1, 98136, -1, 100264, 101608, -1, 99488, -1, 99808, 98440, -1, -1, 99248, -1, 97592, -1, 98336, -1, -1, -1, -1, 99728, 97376, -1, 100256, 98376, 98624, 101112, 96856, -1, 100944, -1, 100840, 100240, 98856, 100184, -1, 102296, 97992, -1, -1, 97336, -1, 100224, -1, 100576, -1, 100520, -1, 102112, 99648, 100584, -1, -1, -1, 101968, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 101592, -1, -1, -1, 98720, -1, -1, 98064, 100424, -1, -1, -1, -1, 100400, 102088, -1, 100416, 99496, -1, -1, -1, 99936, -1, -1, -1, -1, -1, -1, 97144, 96904, 98760, 100656, -1, 98120, 100512, 99112, -1, 96896, -1, -1, -1, -1, -1, 97328, -1, 99872, -1, -1, 101280, 97128, 99552, 102208, 101376, -1, -1, -1, 98552, -1, -1, -1, -1, -1, -1, 98304, 99800, -1, -1, -1, 102264, -1, 97872, -1, -1, 99280, 101744, 101008, 97832, 98560, 99608, -1, -1, 101408, 98088, -1, -1, -1, 101160, -1, -1, 100016, -1, 100152, 100144, 99688, -1, -1, -1, -1, -1, -1, -1, 96872, -1, 100872, -1, -1, 100216, -1, 97232, -1, -1, 97512, -1, 102056, -1, -1, -1, -1, -1, -1, 101200, 98032, -1, -1, 98792, 99560, -1, -1, -1, -1, -1, -1, -1, 101392, -1, -1, -1, 101560, -1, -1, -1, 96912, -1, 99752, -1, -1, 101256, -1, -1, 98752, -1, 97456, -1, -1, -1, -1, -1, 101976, -1, 99888, -1, 100648, -1, 102288, -1, 96944, -1, 102256, -1, -1, -1, 98984, -1, -1, -1, 102224, 100248, -1, 102200, 102096, -1, -1, 98056, -1, -1, 100696, 98768, -1, 97624, -1, 101728, -1, 101952, -1, -1, -1, -1, -1, -1, 97704, -1, -1, -1, -1, 97856, -1, -1, -1, 97816, 99472, -1, 101904, -1, -1, 101768, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 100912, -1, -1, -1, 99504, -1, -1, -1, -1, -1, -1, 97000, -1, -1, 101656, -1, -1, 101944, -1, -1, 97176, -1, -1, -1, -1, 101288, -1, -1, 98864, -1, -1, 98392, -1, 98168, 97160, -1, 101680, -1, -1, 100464, -1, -1, 99400, -1, -1, -1, 97024, 102072, -1, -1, -1, 102008, -1, -1, -1, 98944, -1, -1, -1, 97664, 98024, -1, 101440, -1, -1, -1, -1, 98272, -1, -1, -1, 100632, -1, -1, 102240, -1, -1, -1, 100272, -1, 99368, -1, 97056, -1, -1, -1, 98072, -1, 98664, -1, -1, 97344, 98672, 97408, -1, -1, 96848, -1, -1, 98816, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 98040, -1, 97792, -1, -1, 101760, -1, 101264, -1, -1, 98472, -1, 98352, -1, -1, -1, -1, -1, -1, -1, -1, 101072, -1, -1, -1, -1, -1, 97112, 100360, -1, 99864, -1, -1, -1, -1, 100320, -1, 101504, -1, 101240, 97200, -1, -1, -1, -1, 99856, -1, -1, -1, 101080, -1, -1, -1, -1, -1, -1, -1, -1, 100032, -1, -1, -1, -1, -1, -1, -1, -1, -1, 100920, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 97640, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 99512, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 101936, -1, -1, -1, -1, -1, 100472, -1, -1, -1, -1, -1, 98784, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 101832, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 100792, -1, -1, -1, -1, -1, 97976, 101672, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 99264, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 102168, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 99592, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1};
long int record[5];
void GetBases(){
   /*
    [557aaaa1a000-557aaaa25000 r--p 00000000 00:8c 49799333                   /shared/lab/lab3/lab03_pub/chals]
    [557aaaa25000-557aaaa30000 r-xp 0000b000 00:8c 49799333                   /shared/lab/lab3/lab03_pub/chals]
    [557aaaa30000-557aaaa31000 r--p 00016000 00:8c 49799333                   /shared/lab/lab3/lab03_pub/chals]
    [557aaaa31000-557aaaa33000 r--p 00016000 00:8c 49799333                   /shared/lab/lab3/lab03_pub/chals]
    [557aaaa33000-557aaaa34000 rw-p 00018000 00:8c 49799333                   /shared/lab/lab3/lab03_pub/chals]
    */
    long int main_min = 0, main_max = 0;
    int fd, sz, index = 0;
    char buf[16384], *s = buf, *line, *saveptr;
    if((fd = open("/proc/self/maps", O_RDONLY)) < 0) errquit("get_base/open");
    if((sz = read(fd, buf, sizeof(buf)-1)) < 0) errquit("get_base/read");

    buf[sz] = 0;
    close(fd);
    while((line = strtok_r(s, "\n\r", &saveptr)) != NULL) { 
        s = NULL;
        //if(strstr(line, " r-xp ") == NULL) continue;
        if(strstr(line, "/chal") != NULL) {

            // char* base = strtok(line, "-");
            // printf("%lx\n", strtol(base, NULL, 16));

            if(sscanf(line, "%lx-%lx ", &main_min, &main_max) != 2) errquit("get_base/main");
            //printf("%lx-%lx \n\n", main_min, main_max);
            record[index] = main_min;
            printf("%lx\n", record[index]);
            index++;
        }
    }
    
    if(mprotect(record[3], record[4]-record[3], PROT_WRITE | PROT_READ) <0){
        fprintf(stderr, "error is: %s\n", strerror(errno));
    };

    // return record;
}

int GetCorrectIndex(int num){
    size_t n = sizeof(ndat)/sizeof(ndat[0]);
    int i;
    int flag=0;
    for(i=0; i<n; i++){
        if(num == ndat[i]){
            flag=1;
            break;
        }
    }
    return i;
}

void init(){
    void    *fHandle;
    int     (*new_func)(); // 注意傳入參數和回傳參數的型態
    //int (*fptr)(int);

    GetBases();
    printf("get base done");

    printf("base = %lx\n\n", record[0]);

    fHandle = dlopen("./libpoem.so",RTLD_LAZY);
    if (!fHandle) {
        fprintf (stderr, "%s\n", dlerror());
        exit(1);
    }
    dlerror();

    long int* correct_addr;
    char func_name[10];

    for(int i=0; i<1476; i++){


        if(got_offset[i]== -1)continue;
        correct_addr = (long int*)(record[0] + got_offset[i]);
        sprintf(func_name, "code_%d", i); // get correct phyical function address

        //printf("%s\n", func_name);
        new_func = dlsym(fHandle, func_name); // get physical function address

        *correct_addr = new_func;
    }

    dlclose(fHandle);
}
